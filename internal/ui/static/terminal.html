<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vexShare — Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            display: flex;
            flex-direction: column;
        }
        #toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0.75rem;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        #toolbar .left { display: flex; align-items: center; gap: 0.75rem; }
        #toolbar .right { display: flex; align-items: center; gap: 0.75rem; }
        .badge {
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .badge-controller { background: #238636; color: #fff; }
        .badge-viewer { background: #d29922; color: #fff; }
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.3rem;
        }
        .status-connected { background: #3fb950; }
        .status-disconnected { background: #f85149; }
        .status-connecting { background: #d29922; }
        #clients-count { color: #8b949e; }
        .btn {
            padding: 0.2rem 0.6rem;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.15s;
        }
        .btn:hover { background: #30363d; }
        .btn-danger { border-color: #da3633; color: #f85149; }
        .btn-danger:hover { background: #da363320; }
        #terminal-container {
            flex: 1;
            padding: 4px;
            overflow: hidden;
        }
        .xterm { height: 100%; }
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(13, 17, 23, 0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        #overlay.visible { display: flex; }
        #overlay h2 { color: #f85149; margin-bottom: 0.5rem; }
        #overlay p { color: #8b949e; }
        #overlay .reconnect-btn {
            margin-top: 1rem;
            padding: 0.5rem 1.5rem;
            background: #238636;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <div class="left">
            <strong style="color:#58a6ff;">vexShare</strong>
            <span id="status"><span class="status-dot status-connecting"></span>Connecting…</span>
            <span id="role-badge" class="badge badge-viewer">viewer</span>
            <span id="clients-count"></span>
        </div>
        <div class="right">
            <button class="btn" id="btn-fullscreen" title="Fullscreen">⛶</button>
            <button class="btn btn-danger" id="btn-logout" title="Logout">Logout</button>
        </div>
    </div>
    <div id="terminal-container"></div>
    <div id="overlay">
        <h2 id="overlay-title">Disconnected</h2>
        <p id="overlay-message">The terminal session has ended.</p>
        <button class="reconnect-btn" id="btn-reconnect">Reconnect</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
    <script>
    (function() {
        'use strict';

        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        let wsPath = '/ws';
        const tokenMatch = location.pathname.match(/^\/t\/([^/]+)\/?/);
        if (tokenMatch) {
            wsPath = '/t/' + tokenMatch[1] + '/ws';
        }
        const wsURL = proto + '//' + location.host + wsPath;

        const statusEl = document.getElementById('status');
        const roleBadge = document.getElementById('role-badge');
        const clientsCount = document.getElementById('clients-count');
        const overlay = document.getElementById('overlay');
        const overlayTitle = document.getElementById('overlay-title');
        const overlayMsg = document.getElementById('overlay-message');
        const btnReconnect = document.getElementById('btn-reconnect');
        const btnLogout = document.getElementById('btn-logout');
        const btnFullscreen = document.getElementById('btn-fullscreen');

        const term = new window.Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: "'JetBrains Mono', 'Fira Code', 'Cascadia Code', Menlo, Monaco, 'Courier New', monospace",
            theme: {
                background: '#0d1117',
                foreground: '#c9d1d9',
                cursor: '#58a6ff',
                selectionBackground: '#264f78',
                black: '#484f58',
                red: '#ff7b72',
                green: '#3fb950',
                yellow: '#d29922',
                blue: '#58a6ff',
                magenta: '#bc8cff',
                cyan: '#39d353',
                white: '#b1bac4',
                brightBlack: '#6e7681',
                brightRed: '#ffa198',
                brightGreen: '#56d364',
                brightYellow: '#e3b341',
                brightBlue: '#79c0ff',
                brightMagenta: '#d2a8ff',
                brightCyan: '#56d364',
                brightWhite: '#f0f6fc',
            },
            allowProposedApi: true,
        });

        const fitAddon = new window.FitAddon.FitAddon();
        const webLinksAddon = new window.WebLinksAddon.WebLinksAddon();
        term.loadAddon(fitAddon);
        term.loadAddon(webLinksAddon);
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        let ws = null;
        let myRole = 'viewer';
        let reconnectAttempts = 0;
        const maxReconnectDelay = 10000;

        function setStatus(state, text) {
            const dotClass = state === 'connected' ? 'status-connected' :
                             state === 'disconnected' ? 'status-disconnected' : 'status-connecting';
            statusEl.innerHTML = '<span class="status-dot ' + dotClass + '"></span>' + text;
        }

        function setRole(role) {
            myRole = role;
            roleBadge.textContent = role;
            roleBadge.className = 'badge badge-' + role;
        }

        function sendJSON(obj) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(obj));
            }
        }

        function connect() {
            setStatus('connecting', 'Connecting…');
            overlay.classList.remove('visible');
            ws = new WebSocket(wsURL);

            ws.onopen = function() {
                setStatus('connected', 'Connected');
                reconnectAttempts = 0;
                sendJSON({ type: 'resize', data: { cols: term.cols, rows: term.rows } });
            };

            ws.onmessage = function(e) {
                try {
                    const msg = JSON.parse(e.data);
                    switch (msg.type) {
                        case 'output':
                            term.write(msg.data);
                            break;
                        case 'role':
                            if (msg.data && msg.data.role) {
                                setRole(msg.data.role);
                            }
                            break;
                        case 'clients':
                            if (msg.data && typeof msg.data.count === 'number') {
                                clientsCount.textContent = msg.data.count + ' connected';
                            }
                            break;
                    }
                } catch (err) {
                    console.error('ws message parse error:', err);
                }
            };

            ws.onclose = function(e) {
                setStatus('disconnected', 'Disconnected');
                if (e.code === 1000) {
                    overlayTitle.textContent = 'Session Ended';
                    overlayMsg.textContent = 'The terminal session has been closed.';
                } else {
                    overlayTitle.textContent = 'Disconnected';
                    overlayMsg.textContent = 'Connection lost. Code: ' + e.code;
                }
                overlay.classList.add('visible');
            };

            ws.onerror = function() {
                setStatus('disconnected', 'Error');
            };
        }

        term.onData(function(data) {
            sendJSON({ type: 'input', data: data });
        });

        function sendResize() {
            sendJSON({ type: 'resize', data: { cols: term.cols, rows: term.rows } });
        }

        const resizeObserver = new ResizeObserver(function() {
            fitAddon.fit();
            sendResize();
        });
        resizeObserver.observe(document.getElementById('terminal-container'));

        btnReconnect.addEventListener('click', function() {
            connect();
        });

        btnLogout.addEventListener('click', function() {
            fetch('/logout', { method: 'POST' }).then(function() {
                window.location.href = '/login';
            }).catch(function() {
                window.location.href = '/login';
            });
        });

        btnFullscreen.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(function(){});
            } else {
                document.exitFullscreen();
            }
        });

        document.getElementById('terminal-container').addEventListener('click', function() {
            term.focus();
        });

        connect();
        term.focus();
    })();
    </script>
</body>
</html>
